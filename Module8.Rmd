---
title: "Module_8"
author: "biRds"
date: "14/12/22"
output: html_document
bibliography: BIOL3140.bib
---

### Introductioon
Trans-Gulf migrants (TGMs) are species that migrate from Central and South America and land between Texas and Florida looking for areas to forage and breed. The specific time in which they land is imperative to their longevity, as arriving early could increase chances of finding a mate and increase time for mating, while arriving later would secure food availability.
Population displacement is becoming a serious concern as migration patterns are being disrupted by the increasing severity of climate change, requiring the TGMs to alter the timing of their migration in order to access the same resources as they normally would. TGMs also rely on the environmental cues by stop over points throughout their trip to ensure that the migration will go smoothly, and the longer the migration trip, the less impact a shorter length shift in their departure date will have according to @carey2009the. 
To measure the effects of local weather conditions on TGM arrival time in Massachusetts, a program called eBird will be used for bird ecology data in tandem with meteorological data.

### Methods
After choosing what species of TGMs to study, occurence data from an rgbif function will be used to grab data for each species. NOAA's NCDC API will be used to locate weather stations specific locations throughout the birds trip to Boston. Then, a function called meteo_pull_monitors() will be used to grab weather data from these stations.
Finding the day where 25% of all the individuals of a species has arrived constitutes the "arrival time", and the rest of the species that arrive will follow a logistic curve, modeled with a logistic model in R. After finding the weather data for these dates along the migration path of the species, a rolling mean function will help find the mean of the weather data over 2 weeks before each Julian day. A linear mixed-effect model will allow for analysis of many factors that may affect the relationship between arrival time and local weather. An ANOVA is run over the models to find a best fit model of the data. 

### Results
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(rgbif)
library(tidyverse)
library(MuMIn)
library(rnoaa)
library(data.table)
library(ggmap)
library(usmap)
library(lme4)
library(car)
library(knitr)
library(dplyr)
library(kableExtra)
```

```{r, "Ebird Set up" , include=FALSE, cache=TRUE}
species <- c("Setophaga magnolia","Setophaga tigrina","Setophaga coronata","Setophaga palmarum","Setophaga virens")

y <- paste0("1999",",","2019")
m <- paste0("3",",","6")

dat.l <-list()

for(s in species){
  n.obs <-  occ_data(scientificName = s, year = y, month = m, limit = 0, country = "US", basisOfRecord = "HUMAN_OBSERVATION", stateProvince="Massachusetts")$meta$count 

print(n.obs)

dat.l[[paste0(s)]] <- occ_data(scientificName = s, year = y, month = m, 
                               limit = n.obs, country = "US",
                               basisOfRecord = "HUMAN_OBSERVATION",
                               stateProvince = "Massachusetts")[[2]]

}

saveRDS(dat.l,"massbird.data.RDS")
dat <- readRDS("massbird.data.RDS")
dat <- rbindlist(dat.l,fill=T)
head(dat)

dat%>%
  group_by(year, species)%>%
  summarise(count=sum(individualCount,na.rm = T))%>%
  ggplot(aes(x=year,y=count,col=species))+geom_point()

```

```{r, "Weather Set up" , include=FALSE}

options(noaakey = "MNNiOTQiqymUOFxyhavrXdSobVKuKJyr")

sts <- c(
  "GHCND:USW00013894", #Mobile
  "GHCND:USW00013881", #Charlotte
  "GHCND:USW00014739" #Boston
)

#making one table w/ info about location of the stations
sta.d <- bind_rows( #bind the rows
  lapply(sts,function(x) ncdc_stations(stationid = x)$data ) #use lapply to run through stations
  )%>%
  mutate(usmap_transform(.,input_names = c("longitude","latitude"),output_names = c("longitude.1", "latitude.1")))%>% #join transformation of lat/long for projection with usmap
  mutate(name=str_sub(name, -5,-4))%>%#simplify the name column, grab just the state
  mutate(migr.day=c(10,5,0))%>% #so we can look at wind speed 0, 5 or 10 days before arrive in boston
  separate(id,into = c("station.type","id"))%>%#need to cut station type out from station id number
        print()

#plotting the image of where the stations are
plot_usmap(
  include = c(.northeast_region,.south_region,.east_north_central)
)+geom_point(data=sta.d,aes(x=longitude.1,y=latitude.1,col=name),size=5)+geom_label(data=sta.d,aes(x=longitude.1,y=latitude.1,col=name,label=name),size=5,nudge_x = 1e6*0.25)+theme(legend.position = "none")

#getting  weather info and print table 
weather.d <- meteo_pull_monitors(sta.d$id,date_min = "2000-01-01")
head(weather.d)
```

```{r, "EBird Data Modeling For Magnolia Warbler (sm)" , include=FALSE}
sm<- dat%>%
  filter(species == "Setophaga magnolia")%>%
  group_by(year)%>%
  mutate(date=as.Date(paste0(year,"-",month,"-",day)),
         j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01")))
  )%>%
  group_by(species,year,j.day,date)%>%
  summarise(day.tot=sum(individualCount,na.rm=T))%>%
  group_by(species,year)%>%
  mutate(prop=cumsum(day.tot/sum(day.tot,na.rm = T)))%>%
  filter(year>1999)

sm%>%
  ggplot(aes(j.day,prop))+geom_point()+facet_wrap(year~.)

sm.pred <- sm%>%
  group_by(year)%>%
 summarize(
   pred=predict(nls(prop~SSlogis(j.day,Asym, xmid, scal)),newdata=data.frame(j.day=min(j.day):max(j.day))),#predict the logistic curve for each species
   j.day=min(j.day):max(j.day),
  )%>%
  left_join(sm%>%dplyr::select(j.day,date))

sm%>%
  ggplot(aes(j.day,prop))+geom_point(aes=0.3)+geom_line(data=sm.pred,aes(x=j.day,y=pred),col="blue",size=2)+facet_wrap(year~.)

sm.arrive.date <-sm.pred%>%
  group_by(year)%>%
  filter(j.day==j.day[which.min(abs(pred-0.25))])

sm.arrive.date%>%
  ggplot(aes(year,j.day))+geom_point()

```

```{r, "EBird Data Modeling For Cape May Warbler (st)" , include=FALSE}
st<- dat%>%
  filter(species == "Setophaga tigrina")%>%
  group_by(year)%>%
  mutate(date=as.Date(paste0(year,"-",month,"-",day)),
         j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01")))
  )%>%
  group_by(species,year,j.day,date)%>%
  summarise(day.tot=sum(individualCount,na.rm=T))%>%
  group_by(species,year)%>%
  mutate(prop=cumsum(day.tot/sum(day.tot,na.rm = T)))%>%
  filter(year>1999)

st%>%
  ggplot(aes(j.day,prop))+geom_point()+facet_wrap(year~.)

st.pred <- st%>%
  group_by(year)%>%
 summarize(
   pred=predict(nls(prop~SSlogis(j.day,Asym, xmid, scal)),newdata=data.frame(j.day=min(j.day):max(j.day))),#predict the logistic curve for each species
   j.day=min(j.day):max(j.day),
  )%>%
  left_join(st%>%dplyr::select(j.day,date))

st%>%
  ggplot(aes(j.day,prop))+geom_point(aes=0.3)+geom_line(data=st.pred,aes(x=j.day,y=pred),col="blue",size=2)+facet_wrap(year~.)

st.arrive.date <-st.pred%>%
  group_by(year)%>%
  filter(j.day==j.day[which.min(abs(pred-0.25))])

st.arrive.date%>%
  ggplot(aes(year,j.day))+geom_point()

```

```{r, "EBird Data Modeling For Yellow-Rumped Warbler (sc)" , include=FALSE}
sc<- dat%>%
  filter(species == "Setophaga coronata")%>%
  group_by(year)%>%
  mutate(date=as.Date(paste0(year,"-",month,"-",day)),
         j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01")))
  )%>%
  group_by(species,year,j.day,date)%>%
  summarise(day.tot=sum(individualCount,na.rm=T))%>%
  group_by(species,year)%>%
  mutate(prop=cumsum(day.tot/sum(day.tot,na.rm = T)))%>%
  filter(year>1999)

sc%>%
  ggplot(aes(j.day,prop))+geom_point()+facet_wrap(year~.)

sc.pred <- sc%>%
  group_by(year)%>%
 summarize(
   pred=predict(nls(prop~SSlogis(j.day,Asym, xmid, scal)),newdata=data.frame(j.day=min(j.day):max(j.day))),#predict the logistic curve for each species
   j.day=min(j.day):max(j.day),
  )%>%
  left_join(sc%>%dplyr::select(j.day,date))

sc%>%
  ggplot(aes(j.day,prop))+geom_point(aes=0.3)+geom_line(data=sc.pred,aes(x=j.day,y=pred),col="blue",size=2)+facet_wrap(year~.)

sc.arrive.date <-sc.pred%>%
  group_by(year)%>%
  filter(j.day==j.day[which.min(abs(pred-0.25))])

sc.arrive.date%>%
  ggplot(aes(year,j.day))+geom_point()

```

```{r, "EBird Data Modeling For Palm Warbler (sp)" , include=FALSE}
sp<- dat%>%
  filter(species == "Setophaga palmarum")%>%
  group_by(year)%>%
  mutate(date=as.Date(paste0(year,"-",month,"-",day)),
         j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01")))
  )%>%
  group_by(species,year,j.day,date)%>%
  summarise(day.tot=sum(individualCount,na.rm=T))%>%
  group_by(species,year)%>%
  mutate(prop=cumsum(day.tot/sum(day.tot,na.rm = T)))%>%
  filter(year>1999)

sp%>%
  ggplot(aes(j.day,prop))+geom_point()+facet_wrap(year~.)

sp.pred <- sp%>%
  group_by(year)%>%
 summarize(
   pred=predict(nls(prop~SSlogis(j.day,Asym, xmid, scal)),newdata=data.frame(j.day=min(j.day):max(j.day))),#predict the logistic curve for each species
   j.day=min(j.day):max(j.day),
  )%>%
  left_join(sp%>%dplyr::select(j.day,date))

sp%>%
  ggplot(aes(j.day,prop))+geom_point(aes=0.3)+geom_line(data=sp.pred,aes(x=j.day,y=pred),col="blue",size=2)+facet_wrap(year~.)

sp.arrive.date <-sp.pred%>%
  group_by(year)%>%
  filter(j.day==j.day[which.min(abs(pred-0.25))])

sp.arrive.date%>%
  ggplot(aes(year,j.day))+geom_point()

```

```{r, "EBird Data Modeling For Black-Throated Green Warbler (sv)" , include=FALSE}
sv<- dat%>%
  filter(species == "Setophaga virens")%>%
  group_by(year)%>%
  mutate(date=as.Date(paste0(year,"-",month,"-",day)),
         j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01")))
  )%>%
  group_by(species,year,j.day,date)%>%
  summarise(day.tot=sum(individualCount,na.rm=T))%>%
  group_by(species,year)%>%
  mutate(prop=cumsum(day.tot/sum(day.tot,na.rm = T)))%>%
  filter(year>1999)

sv%>%
  ggplot(aes(j.day,prop))+geom_point()+facet_wrap(year~.)

sv.pred <- sv%>%
  group_by(year)%>%
 summarize(
   pred=predict(nls(prop~SSlogis(j.day,Asym, xmid, scal)),newdata=data.frame(j.day=min(j.day):max(j.day))),#predict the logistic curve for each species
   j.day=min(j.day):max(j.day),
  )%>%
  left_join(sv%>%dplyr::select(j.day,date))

sv%>%
  ggplot(aes(j.day,prop))+geom_point(aes=0.3)+geom_line(data=sv.pred,aes(x=j.day,y=pred),col="blue",size=2)+facet_wrap(year~.)

sv.arrive.date <-sv.pred%>%
  group_by(year)%>%
  filter(j.day==j.day[which.min(abs(pred-0.25))])

sv.arrive.date%>%
  ggplot(aes(year,j.day))+geom_point()

```

```{r, "Weather Data Prep", include=FALSE}
#single day data
weather.d <- weather.d%>%
  mutate(year=as.integer(str_sub(date,1,4)),
         date=as.Date(date))%>%
  group_by(year)%>%
 mutate(j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01"))),
  date2=date,
  wdir.rad=(180-abs(wdf2-180))*pi/180, 
  wvec=cos(wdir.rad)*-1*awnd
  )%>% 
  dplyr::select(id,year,date2,j.day,tmin,tmax,wvec)%>% 
  left_join(sta.d%>%select(id,name,migr.day))%>% 
  mutate(j.day=j.day+migr.day)

#2 week mean data
weather.wk <-weather.d %>% 
  group_by(year,name) %>% 
  mutate(wk.tmin = frollmean(tmin, n=14,align="right"),
         wk.tmax = frollmean(tmax, n=14,align="right"),
         wk.wvec = frollmean(wvec, n=14,align="right")
         )%>%
  dplyr::select(j.day,date2,name,wk.tmin,wk.tmax,wk.wvec)
```

```{r, "eBird and weather data joinnig for Magnolia Warbler", include=FALSE}
sm.arr.weath <- sm.arrive.date%>%
  left_join(weather.d)%>%
  left_join(sm%>%dplyr::select(year,date,j.day))
head(sm.arr.weath)

sm.arr.weath2 <- sm.arrive.date%>%
  left_join(weather.wk)
head(sm.arr.weath2)
```

```{r, "eBird and weather data joinnig for Cape May Warbler", include=FALSE}
st.arr.weath <- st.arrive.date%>%
  left_join(weather.d)%>%
  left_join(st%>%dplyr::select(year,date,j.day))
head(st.arr.weath)

st.arr.weath2 <- st.arrive.date%>%
  left_join(weather.wk)
head(st.arr.weath2)
```

```{r, "eBird and weather data joinnig for Yellow-Rumped Warbler", include=FALSE}
sc.arr.weath <- sc.arrive.date%>%
  left_join(weather.d)%>%
  left_join(sc%>%dplyr::select(year,date,j.day))
head(sc.arr.weath)

sc.arr.weath2 <- sc.arrive.date%>%
  left_join(weather.wk)
head(sc.arr.weath2)
```

```{r, "eBird and weather data joinnig for Palm Warbler", include=FALSE}
sp.arr.weath <- sp.arrive.date%>%
  left_join(weather.d)%>%
  left_join(sp%>%dplyr::select(year,date,j.day))
head(sp.arr.weath)

sp.arr.weath2 <- sp.arrive.date%>%
  left_join(weather.wk)
head(sp.arr.weath2)
```

```{r, "eBird and weather data joinnig for Black-Throated Green Warbler", include=FALSE}
sv.arr.weath <- sv.arrive.date%>%
  left_join(weather.d)%>%
  left_join(sv%>%dplyr::select(year,date,j.day))
head(sv.arr.weath)

sv.arr.weath2 <- sv.arrive.date%>%
  left_join(weather.wk)
head(sv.arr.weath2)
```

```{r, "Linear Mixed-Effect Modelling for Magnolia Warbler" , include=FALSE}

#weather at 0, 5, and 10 days away from arrival
sm.lmer <- lmer(j.day~tmin*tmax*wvec+(1|name),sm.arr.weath,na.action = "na.fail")
Anova(sm.lmer) 

#0Mean two week weather preceding arrival
sm.lmer2 <- lmer(j.day~wk.tmin*wk.tmax*wk.wvec+(1|name),sm.arr.weath2,na.action = "na.fail")
Anova(sm.lmer2) 

sm.arr.aic <- dredge(sm.lmer2,fixed = c("wk.tmin","wk.tmax","wk.wvec"),)

sm.kb <- kable(sm.arr.aic[1:4,],caption = "Fit values for nested models of the most complicated lme model")

kable_styling(sm.kb)

best.lmer <-  lmer(j.day~wk.tmin+wk.tmax+wk.wvec+(1|name),sm.arr.weath2,na.action = "na.fail")

Anova(best.lmer)
```

```{r, "Linear Mixed-Effect Modelling for Cape May Warbler" , include=FALSE}

#weather at 0, 5, and 10 days away from arrival
st.lmer <- lmer(j.day~tmin*tmax*wvec+(1|name),st.arr.weath,na.action = "na.fail")
Anova(st.lmer)

#0Mean two week weather preceding arrival
st.lmer2 <- lmer(j.day~wk.tmin*wk.tmax*wk.wvec+(1|name),st.arr.weath2,na.action = "na.fail")
Anova(st.lmer2) 
st.arr.aic <- dredge(st.lmer2,fixed = c("wk.tmin","wk.tmax","wk.wvec"),)

st.kb <- kable(st.arr.aic[1:4,],caption = "Fit values for nested models of the most complicated lme model")

kable_styling(st.kb)

best.lmer <-  lmer(j.day~wk.tmin+wk.tmax+wk.wvec+(1|name),st.arr.weath2,na.action = "na.fail")

Anova(best.lmer)
```

```{r, "Linear Mixed-Effect Modelling for Yellow-Rumped Warbler" , include=FALSE}

#weather at 0, 5, and 10 days away from arrival
sc.lmer <- lmer(j.day~tmin*tmax*wvec+(1|name),sc.arr.weath,na.action = "na.fail")
Anova(sc.lmer) #Anova from the car package

#0Mean two week weather preceding arrival
sc.lmer2 <- lmer(j.day~wk.tmin*wk.tmax*wk.wvec+(1|name),sc.arr.weath2,na.action = "na.fail")
Anova(sc.lmer2) 

sc.arr.aic <- dredge(sc.lmer2,fixed = c("wk.tmin","wk.tmax","wk.wvec"),)

sc.kb <- kable(sc.arr.aic[1:4,],caption = "Fit values for nested models of the most complicated lme model")

kable_styling(sc.kb)

best.lmer <-  lmer(j.day~wk.tmin+wk.tmax+wk.wvec+(1|name),sc.arr.weath2,na.action = "na.fail")

Anova(best.lmer)
```

```{r, "Linear Mixed-Effect Modelling for Palm Warbler" , include=FALSE}

#weather at 0, 5, and 10 days away from arrival
sp.lmer <- lmer(j.day~tmin*tmax*wvec+(1|name),sp.arr.weath,na.action = "na.fail")
Anova(sp.lmer) #Anova from the car package

#0Mean two week weather preceding arrival
sp.lmer2 <- lmer(j.day~wk.tmin*wk.tmax*wk.wvec+(1|name),sp.arr.weath2,na.action = "na.fail")
Anova(sp.lmer2) 

sp.arr.aic <- dredge(sp.lmer2,fixed = c("wk.tmin","wk.tmax","wk.wvec"),)

sp.kb <- kable(sp.arr.aic[1:4,],caption = "Fit values for nested models of the most complicated lme model")

kable_styling(sp.kb)

best.lmer <-  lmer(j.day~wk.tmin+wk.tmax+wk.wvec+(1|name),sp.arr.weath2,na.action = "na.fail")

Anova(best.lmer)
```

```{r, "Linear Mixed-Effect Modelling for Black-Throated Green Warbler" , include=FALSE}

#weather at 0, 5, and 10 days away from arrival
sv.lmer <- lmer(j.day~tmin*tmax*wvec+(1|name),sv.arr.weath,na.action = "na.fail")
Anova(sv.lmer) #Anova from the car package

#0Mean two week weather preceding arrival
sv.lmer2 <- lmer(j.day~wk.tmin*wk.tmax*wk.wvec+(1|name),sv.arr.weath2,na.action = "na.fail")
Anova(sv.lmer2) 

sv.arr.aic <- dredge(sv.lmer2,fixed = c("wk.tmin","wk.tmax","wk.wvec"),)

sv.kb <- kable(sv.arr.aic[1:4,],caption = "Fit values for nested models of the most complicated lme model")

kable_styling(sv.kb)

best.lmer <-  lmer(j.day~wk.tmin+wk.tmax+wk.wvec+(1|name),sv.arr.weath2,na.action = "na.fail")

Anova(best.lmer)
```

### Discussion

### Author Contribution
Sabrina G. wrote the introduction and method sections.
Clémentine P. did the R-coding for this project, and the editing of the project.
Stefanie F.