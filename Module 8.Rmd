---
title: "Moduke 8"
author: "biRds"
date: "`r Sys.Date()`"
output: html_document
---

### Introductioon
Trans-Gulf migrants (TGMs) are species that migrate from Central and South America and land between Texas and Florida looking for areas to forage and breed. The specific time in which they land is imperative to their longevity, as arriving early could increase chances of finding a mate and increase time for mating, while arriving later would secure food availability.
Population displacement is becoming a serious concern as migration patterns are being disrupted by the increasing severity of climate change, requiring the TGMs to alter the timing of their migration in order to access the same resources as they normally would. TGMs also rely on the environmental cues by stop over points throughout their trip to ensure that the migration will go smoothly, and the longer the migration trip, the less impact a shorter length shift in their departure date will have according to @carey2009the. 
To measure the effects of local weather conditions on TGM arrival time in Massachusetts, a program called eBird will be used for bird ecology data in tandem with meteorological data.

### Methods
After choosing what species of TGMs to study, occurence data from an rgbif function will be used to grab data for each species. NOAA's NCDC API will be used to locate weather stations specific locations throughout the birds trip to Boston. Then, a function called meteo_pull_monitors() will be used to grab weather data from these stations.
Finding the day where 25% of all the individuals of a species has arrived constitutes the "arrival time", and the rest of the species that arrive will follow a logistic curve, modeled with a logistic model in R. After finding the weather data for these dates along the migration path of the species, a rolling mean function will help find the mean of the weather data over 2 weeks before each Julian day. A linear mixed-effect model will allow for analysis of many factors that may affect the relationship between arrival time and local weather. An ANOVA is run over the models to find a best fit model of the data. 

### Results
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(rgbif)
library(dplyr)
library(tidyverse)
library(MuMIn)
library(rnoaa)
library(data.table)
library(ggmap)
library(usmap)
library(lme4)
library(car)
```

```{r, "Ebird Set up" , include=FALSE}
species <- c("Setophaga dominica","Vireo griseus","Vireo flavifrons","Vermivora chrysoptera","Setophaga virens")

y <- paste0("1990",",","2019")
m <- paste0("3",",","6")

dat.l <-list()

for(s in species){
  n.obs <-  occ_data(scientificName = s, year = y, month = m, limit = 0, country = "US", basisOfRecord = "HUMAN_OBSERVATION", stateProvince="Massachusetts")$meta$count 

print(n.obs)

dat.l[[paste0(s)]] <- occ_data(scientificName = s, year = y, month = m, 
                               limit = n.obs, country = "US",
                               basisOfRecord = "HUMAN_OBSERVATION",
                               stateProvince = "Massachusetts")[[2]]

}

dat <- rbindlist(dat.l,fill=T)

dat%>%
  group_by(year, species)%>%
  summarise(count=sum(individualCount,na.rm = T))%>%
  ggplot(aes(x=year,y=count,col=species))+geom_point()

```

```{r, "Weather Set up" , include=FALSE}

options(noaakey = "MNNiOTQiqymUOFxyhavrXdSobVKuKJyr")

sts <- c(
  "GHCND:USW00013894", #Mobile
  "GHCND:USW00013881", #Charlotte
  "GHCND:USW00014739" #Boston
)

#making one table w/ info about location of the stations
sta.d <- bind_rows( #bind the rows
  lapply(sts,function(x) ncdc_stations(stationid = x)$data ) #use lapply to run through stations
  )%>%
  mutate(usmap_transform(.,input_names = c("longitude","latitude"),output_names = c("longitude.1", "latitude.1")))%>% #join transformation of lat/long for projection with usmap
  mutate(name=str_sub(name, -5,-4))%>%#simplify the name column, grab just the state
  mutate(migr.day=c(10,5,0))%>% #so we can look at wind speed 0, 5 or 10 days before arrive in boston
  separate(id,into = c("station.type","id"))%>%#need to cut station type out from station id number
        print()

#plotting the image of where the stations are
plot_usmap(
  include = c(.northeast_region,.south_region,.east_north_central)
)+geom_point(data=sta.d,aes(x=longitude.1,y=latitude.1,col=name),size=5)+geom_label(data=sta.d,aes(x=longitude.1,y=latitude.1,col=name,label=name),size=5,nudge_x = 1e6*0.25)+theme(legend.position = "none")

#getting  weather info and print table 
weather.d <- meteo_pull_monitors(sta.d$id,date_min = "2000-01-01")
head(weather.d)
```

```{r, "EBird Data Prep" , include=FALSE}
mc<- dat%>%
  filter(species=="Setophaga dominica")%>%
  group_by(year)%>%
  mutate(date=as.Date(paste0(year,"-",month,"-",day)),
         j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01")))
  )%>%
  group_by(species,year,j.day,date)%>%
  summarise(day.tot=sum(individualCount,na.rm=T))%>%
  group_by(species,year)%>%
  mutate(prop=cumsum(day.tot/sum(day.tot,na.rm = T)))%>%
  filter(year>1999)

mc%>%
  ggplot(aes(j.day,prop))+geom_point()+facet_wrap(year~.)

mc.pred <- mc%>%
  group_by(year)%>%
 summarize(
   pred=predict(nls(prop~SSlogis(j.day,Asym, xmid, scal)),newdata=data.frame(j.day=min(j.day):max(j.day))),#predict the logistic curve for each species
   j.day=min(j.day):max(j.day),
  )%>%
  left_join(mc%>%dplyr::select(j.day,date))
mc%>%
  ggplot(aes(j.day,prop))+geom_point(aes=0.3)+geom_line(data=mc.pred,aes(x=j.day,y=pred),col="blue",size=2)+facet_wrap(year~.)

````
### Discussion

### Author Contribution